#
# Network definitions
#
networks:
  ncp:
    name: epps

volumes:
  db-data:
  tsam-exporter-data:

secrets:
  db_username:
    file: db_username.txt
  db_password:
    file: db_password.txt
  db_root_password:
    file: db_root_password.txt
  cts_password:
    file: cts_password.txt
  cts_username:
    file: cts_username.txt
  tls_keystore_password:
    file: tls_keystore_password.txt
  seal_keystore_password:
    file: seal_keystore_password.txt
  tls_truststore_password:
    file: tls_truststore_password.txt

services:
  #
  # Database
  #
  mariadb:
    image: mariadb:11.1
    restart: on-failure
    container_name: openncp-database
    ports:
      - "33306:3306"
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MARIADB_USER_FILE: /run/secrets/db_username
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
    volumes:
      - ./mariadb/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./mariadb/init-scripts:/docker-entrypoint-initdb.d-original:ro
      - db-data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
    entrypoint: /usr/local/bin/entrypoint.sh
    secrets:
      - db_username
      - db_password
      - db_root_password
    networks:
      - ncp
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized" ]
      interval: 10s
      timeout: 5s
      retries: 3


  #
  # Configuration synchronizer.
  # Watches OPENNCP_CONFIGURATION_FILE for changes and sends content to
  # configuration database table.
  #
  configuration-synchronizer:
    build:
      context: configuration-synchronizer
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    container_name: configuration-synchronizer
    image: eppsregistry.azurecr.io/configuration-synchronizer:${OPENNCP_VERSION}
    volumes:
      - ./openncp-configuration:/opt/openncp-configuration
    environment:
      OPENNCP_CONFIGURATION_FILE: /opt/openncp-configuration/openncp-configuration.properties
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      TLS_KEYSTORE_ALIAS: ${TLS_KEYSTORE_ALIAS}
      # This also needs to be configured in openncp-configuration/ATNA_resources/ArrConnections.xml
      TLS_KEYSTORE_FILE: ${TLS_KEYSTORE_FILE}
      TLS_KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password
      SEAL_KEYSTORE_ALIAS: ${SEAL_KEYSTORE_ALIAS}
      SEAL_KEYSTORE_FILE: /opt/openncp-configuration/cert/DK_SEAL_TEST.jks
      SEAL_KEYSTORE_PASSWORD_FILE: /run/secrets/seal_keystore_password
      TLS_TRUSTSTORE_FILE: ${TLS_TRUSTSTORE_FILE}
      TLS_TRUSTSTORE_PASSWORD_FILE: /run/secrets/tls_truststore_password
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - ncp
    secrets:
      - db_password
      - db_username
      - tls_keystore_password
      - seal_keystore_password
      - tls_truststore_password

  #
  # Download terminology database from CTS. Batch job.
  # Usage: `docker compose run tsam-synchronizer`.
  #
  tsam-synchronizer:
    profiles: ["initialization"] # prevents service from starting on `docker compose up`
    build:
      context: .
      dockerfile: ./tsam-synchronizer/Dockerfile
      args:
        openncp_version: ${OPENNCP_VERSION}
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    image: eppsregistry.azurecr.io/tsam-synchronizer:${OPENNCP_VERSION}
    volumes:
      - ./openncp-configuration:/opt/openncp-configuration/
    environment:
      CTS_URL: ${CTS_URL}
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      CTS_PASSWORD_FILE: /run/secrets/cts_password
      CTS_USERNAME_FILE: /run/secrets/cts_username
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - ncp
    secrets:
      - db_password
      - db_username
      - cts_password
      - cts_username

  #
  # NCP server / inbound protocol terminator
  #
  openncp-server:
    build:
      context: ./
      dockerfile: ./openncp-server/Dockerfile
      args:
        openncp_version: ${OPENNCP_VERSION}
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    container_name: openncp-server
    image: eppsregistry.azurecr.io/openncp-server:${OPENNCP_VERSION}
    ports:
      - "6443:6443"
      - "8080:8080"
      # - "5005:5005"
    depends_on:
      - mariadb
      - configuration-synchronizer
    environment:
      # JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,address=*:5005,server=y,suspend=n"
      NC_DK_COUNTRY_A_HOST: "http://epps-country-a:8080"
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      TLS_KEYSTORE_ALIAS: ${TLS_KEYSTORE_ALIAS}
      TLS_KEYSTORE_FILE: ${TLS_KEYSTORE_FILE}
      TLS_KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password
      TLS_TRUSTSTORE_FILE: ${TLS_TRUSTSTORE_FILE}
      TLS_TRUSTSTORE_PASSWORD_FILE: /run/secrets/tls_truststore_password
    volumes:
      - ./openncp-configuration:/opt/openncp-configuration
      - ./logs/openncp-server:/usr/local/tomcat/logs
    networks:
      - ncp
    secrets:
      - db_password
      - db_username
      - tls_keystore_password
      - seal_keystore_password
      - tls_truststore_password

  #
  # NCP client / outbound protocol terminator
  #
  openncp-client:
    build:
      context: ./
      dockerfile: ./openncp-client/Dockerfile
      args:
        openncp_version: ${OPENNCP_VERSION}
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    container_name: openncp-client
    image: eppsregistry.azurecr.io/openncp-client:${OPENNCP_VERSION}
    ports:
      - "7443:7443"
      - "8081:8081"
    depends_on:
      - mariadb
      - configuration-synchronizer
    environment:
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      TLS_KEYSTORE_ALIAS: ${TLS_KEYSTORE_ALIAS}
      TLS_KEYSTORE_FILE: ${TLS_KEYSTORE_FILE}
      TLS_KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password
    volumes:
      - ./openncp-configuration:/opt/openncp-configuration
      - ./logs/openncp-client:/usr/local/tomcat/logs
    networks:
      - ncp
    secrets:
      - db_password
      - db_username
      - tls_keystore_password
      - tls_truststore_password

  #
  # Gateway, TRC-STS, OpenATNA
  #
  openncp-gateway:
    build:
      context: ./
      dockerfile: ./openncp-gateway/Dockerfile
      args:
        openncp_version: ${OPENNCP_VERSION}
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    container_name: openncp-gateway
    image: eppsregistry.azurecr.io/openncp-gateway:${OPENNCP_VERSION}
    ports:
      - "8443:8443"
      - "8082:8082"
      - "2861:2861"
      # - "5006:5006"
    depends_on:
      - mariadb
      - configuration-synchronizer
    environment:
      # JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,address=*:5006,server=y,suspend=n"
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      TLS_KEYSTORE_ALIAS: ${TLS_KEYSTORE_ALIAS}
      TLS_KEYSTORE_FILE: ${TLS_KEYSTORE_FILE}
      TLS_KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password
    volumes:
      - ./openncp-configuration:/opt/openncp-configuration
      - ./logs/openncp-gateway:/usr/local/tomcat/logs
      - ./logs/validation/gateway:/opt/openncp-configuration/validation
    networks:
      - ncp
    secrets:
      - db_password
      - db_username
      - tls_keystore_password
  
  # OpenNCP Backend Portal (Node B)
  ehealth-portal-backend:
    build:
      context: .
      dockerfile: ./ehealth-portal-backend/Dockerfile
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    container_name: ehealth-portal-backend
    ports:
      - "8092:8080"
      - "5443:8443"
    environment:
      TLS_KEYSTORE_PWD_FILE: /run/secrets/tls_keystore_password
      TLS_TRUSTSTORE_PWD_FILE: /run/secrets/tls_truststore_password
      TLS_KEYSTORE_PATH: /opt/openncp-configuration/cert/test-keystore.jks
      TLS_TRUSTSTORE_PATH: /opt/openncp-configuration/cert/test-truststore.jks
      TLS_KEY_ALIAS: tls
      DATASOURCE_CLASS_NAME: com.mysql.cj.jdbc.MysqlDataSource
      DRIVER_CLASS_NAME: com.mysql.cj.jdbc.Driver
      DB_ACTIVE_PROFILE: mysql # Unsure of the purpose of this variable
      CONNECTOR_PORT=: 443
      KEY_ALIAS: gazelle.ncp-sp.openncp.dg-sante.euk
      KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password #This is probably not intended to be the same as the TLS keystore, but we are reusing it as a MVP
      TRUSTSTORE_PASSWORD_FILE: /run/secrets/tls_truststore_password #This is probably not intended to be the same as the TLS truststore, but we are reusing it as a MVP
      CLIENT_AUTH: false #This should be set to false as per the documentation (https://webgate.ec.europa.eu/fpfis/wikis/display/EHDSI/OpenNCP+Installation+Manual 2024-06-20, #3.2)
      DB_HOST: mariadb
      DB_INTERNAL_PORT: 3306  #Why does it need the internal port?
      DB_EXPOSED_PORT: 33306
      DB_ROOT_USER: root   #WHY DOES THIS NEED ROOT USER PRIVELEGES?
      DB_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      DB_USER_FILE: /run/secrets/db_username
      DB_PASSWORD_FILE: /run/secrets/db_password
      DB_TYPE: mysql
    volumes:
      - ./logs/ehealth-portal-backend:/usr/local/tomcat/logs
      - ./ehealth-portal-backend/certificates:/opt/openncp-configuration/keystore
      - tsam-exporter-data:/opt/openncp-configuration/EpsosRepository
    networks:
      - ncp
    depends_on:
      - mariadb
      - configuration-synchronizer
      - openncp-client
    secrets:
      - db_password
      - db_username
      - db_root_password
      - tls_keystore_password
      - tls_truststore_password
    dns:
      - 8.8.8.8

  # # OpenNCP Frontend Portal (Node B)
  # # Portal Frontend
  ehealth-portal-frontend:
    container_name: ehealth-portal-frontend
    build:
      context: ./ehealth-portal-frontend
      platforms:
        - "linux/amd64"
        - "linux/arm64"
      dockerfile: Dockerfile
    ports:
      - "8093:8080"
    depends_on:
      - ehealth-portal-backend
    volumes:
      - ./logs/ehealth-portal-frontend:/usr/local/tomcat/logs
    networks:
      - ncp