version: '3.5'

#
# Network definitions
#
networks:
  epps-backend:

services:
  #
  # epps-backend
  #
  epps-backend:
    image: eclipse-temurin:17-jre-alpine
    command: sh /setup/run-in-container.sh /code/epps-application.jar
    container_name: epps-backend-application
    ports:
      - "4000:4000"
      - "8080:8080"
    environment:
      - "JAVA_DEBUG=${JAVA_DEBUG:-}"
      - "SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}"
      - "SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb-server/epps"
      - "SPRING_DATASOURCE_USERNAME=epps"
      - "SPRING_DATASOURCE_PASSWORD=epps"
    volumes:
      - ./epps-application/target/epps-application.jar:/code/epps-application.jar:ro
      - ./epps-application/src/main/scripts/:/setup/:ro
    links:
      - mariadb-server:mariadb-server
      - epps-fmk-mock:epps-fmk-mock
    depends_on:
      - mariadb-server
    networks:
      - epps-backend

  #
  # epps-backend
  #
  epps-fmk-mock:
    image: eclipse-temurin:17-jre-alpine
    command: sh /setup/run-in-container.sh /code/epps-fmk-mock.jar
    container_name: epps-fmk-mock
    ports:
      - "4001:4000"
      - "8081:8080"
    environment:
      - "JAVA_DEBUG=${JAVA_DEBUG:-}"
      - "SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}"
    volumes:
      - ./epps-mocks/epps-fmk-mock/target/epps-fmk-mock.jar:/code/epps-fmk-mock.jar:ro
      - ./epps-application/src/main/scripts/:/setup/:ro
    networks:
      - epps-backend

  #
  # Database
  #
  mariadb-server:
    image: mariadb:11.1
    restart: always
    container_name: epps-backend-database
    ports:
      - "3306:3306"
    environment:
      - "MARIADB_ROOT_PASSWORD=7b1c3deda5144f99a6973f462215b8cd"
      - "MARIADB_USER=epps"
      - "MARIADB_PASSWORD=epps"
      - "MARIADB_DATABASE=epps"
    #volumes:
    #  - type: volume
    #    source: dbdata
    #    target: /var/lib/mysql
    #    read_only: false
    networks:
      - epps-backend

#volumes:
#  dbdata:
#    driver: local
