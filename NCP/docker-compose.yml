# Use by settings IMAGE_TAG in the environment or when running docker compose
# e.g. IMAGE_TAG=latest docker compose up

#
# Network definitions
#
networks:
  ncp:
    name: epps

volumes:
  db-data:
  tsam-exporter-data:

secrets:
  db_username:
    file: db_username.txt
  db_password:
    file: db_password.txt
  db_root_password:
    file: db_root_password.txt
  cts_password:
    file: cts_password.txt
  cts_username:
    file: cts_username.txt
  tls_keystore_password:
    file: tls_keystore_password.txt
  seal_keystore_password:
    file: seal_keystore_password.txt
  tls_truststore_password:
    file: tls_truststore_password.txt

services:
  mysql:
    container_name: openncp_db
    hostname: ${DB_HOST}
    image: mysql:9
    ports:
      - ${DB_EXPOSED_PORT}:${DB_INTERNAL_PORT}
    volumes:
      - db-data:/var/lib/mysql
      - ./mysql/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./mysql/initdb:/docker-entrypoint-initdb.d-original:ro
    entrypoint: /usr/local/bin/entrypoint.sh
    environment:
      MYSQL_ROOT_USER: ${DB_ROOT_USER}
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_USER_FILE: /run/secrets/db_username
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${DB_ROOT_USER}", "--password=$$(cat $$MYSQL_ROOT_PASSWORD_FILE)" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ncp
    secrets:
      - db_username
      - db_password
      - db_root_password

  # Usage: docker compose run tsam-exporter
  # Run this to generate language files for the CDA display tool.
  tsam-exporter:
    profiles: ["initialization"] # prevents service from starting on `docker compose up`
    container_name: "tsam-exporter"
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-tsam-exporter:${IMAGE_TAG}
    env_file: .env
    environment:
      DB_HOST: ${DB_HOST}
      DB_INTERNAL_PORT: ${DB_INTERNAL_PORT}
      DB_USER_FILE: /run/secrets/db_username
      DRIVER_CLASS_NAME: ${DRIVER_CLASS_NAME}
      DB_PASSWORD_FILE: /run/secrets/db_password
      DB_ACTIVE_PROFILE: ${DB_ACTIVE_PROFILE}
    build:
      target: tsam-exporter
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - tsam-exporter-data:/opt/openncp-configuration/EpsosRepository
    networks:
      - ncp
    secrets:
      - db_username
      - db_password

  tomcat_node_a:
    build:
      target: node-a
    container_name: "openncp-server"
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-node-a:${IMAGE_TAG}
    env_file:
      - ./ncp_a/ncpa.database.env
      - ./ncp_a/ncpa.env
    ports:
      - "${NCP_A_SERVER_CONNECTOR_PORT}:${NCP_A_SERVER_CONNECTOR_PORT}"
      - "${NCP_A_SERVER_CONNECTOR_SECURE_PORT}:${NCP_A_SERVER_CONNECTOR_SECURE_PORT}"
      # - 5005:5005
    depends_on:
      mysql:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    environment:
      # JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,address=*:5005,server=y,suspend=n"
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  tomcat_node_b:
    build:
      target: node-b
    container_name: "openncp-client"
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-node-b:${IMAGE_TAG}
    env_file:
      - ./ncp_b/ncpb.database.env
      - ./ncp_b/ncpb.env
    ports:
      - "${NCP_B_SERVER_CONNECTOR_PORT}:${NCP_B_SERVER_CONNECTOR_PORT}"
      - "${NCP_B_SERVER_CONNECTOR_SECURE_PORT}:${NCP_B_SERVER_CONNECTOR_SECURE_PORT}"
      # - 5006:5006
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,address=*:5006,server=y,suspend=n"
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  openncp-openatna:
    container_name: openncp-openatna
    build:
      target: openatna
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-openatna:${IMAGE_TAG}
    env_file:
      - ./openncp-openatna/openatna.database.env
      - ./openncp-openatna/openatna.env
    ports:
      - "${NCP_OPENATNA_CONNECTOR_PORT}:${NCP_OPENATNA_CONNECTOR_PORT}"
      - "${NCP_OPENATNA_CONNECTOR_SECURE_PORT}:${NCP_OPENATNA_CONNECTOR_SECURE_PORT}"
      - "2861:2861/udp"
      - "2862:2862"
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  openncp-trc-sts:
    container_name: openncp-trc-sts
    build:
      target: trc-sts
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-trc-sts:${IMAGE_TAG}
    env_file:
      - ./openncp-trc-sts/.database.env
      - ./openncp-trc-sts/.env
    ports:
      - "${NCP_TRC_STS_CONNECTOR_PORT}:${NCP_TRC_STS_CONNECTOR_PORT}"
      - "${NCP_TRC_STS_CONNECTOR_SECURE_PORT}:${NCP_TRC_STS_CONNECTOR_SECURE_PORT}"
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8
        -Dorg.apache.cxf.stax.allowInsecureParser=true"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  openncp-translations-and-mappings:
    container_name: openncp-translations-and-mappings
    build:
      target: translations-and-mappings
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-translations-and-mappings:${IMAGE_TAG}
    env_file:
      - ./openncp-translations-and-mappings/translations-and-mappings.database.env
      - ./openncp-translations-and-mappings/translations-and-mappings.env
    ports:
      - "${NCP_TRANSLATIONS_MAPPINGS_CONNECTOR_PORT}:${NCP_TRANSLATIONS_MAPPINGS_CONNECTOR_PORT}"
      - "${NCP_TRANSLATIONS_MAPPINGS_CONNECTOR_SECURE_PORT}:${NCP_TRANSLATIONS_MAPPINGS_CONNECTOR_SECURE_PORT}"
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  openncp-web-manager:
    container_name: openncp-web-manager
    build:
      target: web-manager
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-web-manager-backend:${IMAGE_TAG}
    env_file:
      - ./openncp-web-manager/.database.env
      - ./openncp-web-manager/.env
    ports:
      - "${NCP_WEB_MANAGER_BACKEND_CONNECTOR_PORT}:${NCP_WEB_MANAGER_BACKEND_CONNECTOR_PORT}"
      - "${NCP_WEB_MANAGER_BACKEND_CONNECTOR_SECURE_PORT}:${NCP_WEB_MANAGER_BACKEND_CONNECTOR_SECURE_PORT}"
      - "8000:8000"
    volumes:
      - ./keystore:/opt/openncp-configuration/keystore
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: production
      SPRING_CONFIG_ADDITIONAL-LOCATION: file:/opt/config/application-docker.yml
      CATALINA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      JAVA_OPTS: "
        -DopenATNA.properties.path=file:/opt/atna-resources/openatna.properties
        -Dfile.encoding=UTF-8"
      # LOGGING_LEVEL_ROOT: DEBUG
    networks:
      - ncp
    secrets:
      - tls_keystore_password
      - tls_truststore_password
      - db_username
      - db_password

  configuration-synchronizer:
    build:
      context: configuration-synchronizer
    container_name: configuration-synchronizer
    image: ghcr.io/sundhedsdatastyrelsen/ehdsi/dk-ncp-configuration-utility:${IMAGE_TAG}
    env_file: .env
    volumes:
      - ./openncp-configuration/openncp-configuration.properties:/opt/openncp-configuration/openncp-configuration.properties:ro
      - ./keystore:/opt/openncp-configuration/keystore
    environment:
      OPENNCP_CONFIGURATION_FILE: /opt/openncp-configuration/openncp-configuration.properties
      MARIADB_HOST: ${DB_HOST}
      MARIADB_PORT: ${DB_INTERNAL_PORT}
      MARIADB_PASSWORD_FILE: /run/secrets/db_password
      MARIADB_USERNAME_FILE: /run/secrets/db_username
      TLS_KEYSTORE_PASSWORD_FILE: /run/secrets/tls_keystore_password
      SEAL_KEYSTORE_PASSWORD_FILE: /run/secrets/seal_keystore_password
      TLS_TRUSTSTORE_PASSWORD_FILE: /run/secrets/tls_truststore_password
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ncp
    secrets:
      - db_username
      - db_password
      - tls_keystore_password
      - seal_keystore_password
      - tls_truststore_password
